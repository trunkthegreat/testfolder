<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Text-to-Speech</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafb 0%, #e8f2f1 100%);
            color: #2c3e50;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 106, 77, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #006A4D 0%, #0B3122 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

            .header h1 {
                font-size: 2rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .header p {
                opacity: 0.9;
                font-size: 1rem;
            }

        .help-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

            .help-toggle:hover {
                background: rgba(255, 255, 255, 0.3);
            }

        .guidelines {
            background: rgba(0, 106, 77, 0.05);
            border: 2px solid rgba(0, 106, 77, 0.1);
            margin: 1rem;
            padding: 1.5rem;
            border-radius: 12px;
            display: none;
        }

            .guidelines.show {
                display: block;
            }

        .guidelines-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #006A4D;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

            .guidelines-title::before {
                content: ⌨️';
                margin-right: 0.5rem;
            }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .shortcut-group {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 106, 77, 0.1);
        }

            .shortcut-group h4 {
                color: #006A4D;
                margin-bottom: 0.75rem;
                font-size: 0.95rem;
            }

        .shortcut {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

            .shortcut:last-child {
                margin-bottom: 0;
            }

        .key {
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
            border: 1px solid #dee2e6;
            min-width: 60px;
            text-align: center;
        }

        .content {
            padding: 2rem;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #006A4D;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

            .section-title::before {
                content: '';
                width: 4px;
                height: 20px;
                background: #006A4D;
                margin-right: 0.75rem;
                border-radius: 2px;
            }

        .text-input {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

            .text-input:focus {
                outline: none;
                border-color: #006A4D;
                box-shadow: 0 0 0 3px rgba(0, 106, 77, 0.1);
            }

        .preview-section {
            margin-top: 1rem;
        }

        .preview-container {
            background: #f8fafb;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-text {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #495057;
            white-space: pre-wrap;
        }

        .processing-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            accent-color: #006A4D;
        }

        .checkbox-label {
            font-size: 0.9rem;
            color: #495057;
            cursor: pointer;
        }

        .language-buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .lang-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #006A4D;
            background: white;
            color: #006A4D;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

            .lang-btn::after {
                content: attr(data-key);
                position: absolute;
                top: -8px;
                right: -8px;
                background: #006A4D;
                color: white;
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                border-radius: 4px;
                font-weight: 600;
            }

            .lang-btn.active::after {
                background: #ffffff;
                color: #006A4D;
            }

        .lang-count {
            background: rgba(0, 106, 77, 0.15);
            color: #006A4D;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            min-width: 20px;
        }

        .lang-btn.active .lang-count {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .lang-btn:hover {
            background: #f0f7f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 106, 77, 0.2);
        }

        .lang-btn.active {
            background: #006A4D;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 106, 77, 0.3);
        }

        .voice-selector {
            margin-bottom: 1.5rem;
        }

        .voice-info {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #f8fafb;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .voice-info-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .voice-quality {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .voice-details {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .voice-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

            .voice-select option {
                padding: 0.5rem;
                font-size: 0.95rem;
            }

                .voice-select option:first-child {
                    color: #006A4D;
                    font-weight: 600;
                }

            .voice-select:focus {
                outline: none;
                border-color: #006A4D;
                box-shadow: 0 0 0 3px rgba(0, 106, 77, 0.1);
            }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-group {
            background: #f8fafb;
            padding: 1.25rem;
            border-radius: 12px;
            border: 1px solid #e1e8ed;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #34495e;
        }

        .control-value {
            background: #006A4D;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e1e8ed;
            outline: none;
            appearance: none;
            cursor: pointer;
        }

            .slider::-webkit-slider-thumb {
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #006A4D;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0, 106, 77, 0.3);
                transition: all 0.3s ease;
            }

                .slider::-webkit-slider-thumb:hover {
                    transform: scale(1.2);
                    box-shadow: 0 4px 12px rgba(0, 106, 77, 0.4);
                }

            .slider::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #006A4D;
                cursor: pointer;
                border: none;
                box-shadow: 0 2px 6px rgba(0, 106, 77, 0.3);
            }

            .slider::-moz-range-track {
                height: 6px;
                border-radius: 3px;
                background: #e1e8ed;
                border: none;
            }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

            .btn::after {
                content: attr(data-key);
                position: absolute;
                top: -8px;
                right: -8px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                border-radius: 4px;
                font-weight: 600;
            }

        .btn-primary {
            background: linear-gradient(135deg, #006A4D 0%, #0B3122 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 106, 77, 0.3);
        }

            .btn-primary:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 106, 77, 0.4);
            }

        .btn-secondary {
            background: white;
            color: #006A4D;
            border: 2px solid #006A4D;
        }

            .btn-secondary:hover {
                background: #f0f7f5;
                transform: translateY(-2px);
            }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

            .btn-warning:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
            }

        .status {
            text-align: center;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
        }

            .status.speaking {
                background: #e8f5e8;
                color: #2d6a2d;
                border: 1px solid #c3e6c3;
            }

            .status.paused {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .language-buttons {
                justify-content: center;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .shortcuts-grid {
                grid-template-columns: 1fr;
            }

            .processing-options {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="help-toggle" onclick="toggleGuidelines()">⌨️ Keyboard Shortcuts</button>
            <h1>Professional Text-to-Speech</h1>
            <p>Advanced natural voice synthesis with markdown processing and speech enhancement</p>
        </div>

        <div id="guidelines" class="guidelines">
            <div class="guidelines-title">Keyboard Shortcuts Guide</div>
            <div class="shortcuts-grid">
                <div class="shortcut-group">
                    <h4>🎤 Speech Controls</h4>
                    <div class="shortcut">
                        <span>Start Speaking</span>
                        <span class="key">Space</span>
                    </div>
                    <div class="shortcut">
                        <span>Pause/Resume</span>
                        <span class="key">P</span>
                    </div>
                    <div class="shortcut">
                        <span>Stop Speech</span>
                        <span class="key">Esc</span>
                    </div>
                </div>

                <div class="shortcut-group">
                    <h4>🌐 Language Selection</h4>
                    <div class="shortcut">
                        <span>English</span>
                        <span class="key">1</span>
                    </div>
                    <div class="shortcut">
                        <span>Japanese</span>
                        <span class="key">2</span>
                    </div>
                    <div class="shortcut">
                        <span>Vietnamese</span>
                        <span class="key">3</span>
                    </div>
                </div>

                <div class="shortcut-group">
                    <h4>⚡ Voice Controls</h4>
                    <div class="shortcut">
                        <span>Increase Rate</span>
                        <span class="key">+</span>
                    </div>
                    <div class="shortcut">
                        <span>Decrease Rate</span>
                        <span class="key">-</span>
                    </div>
                    <div class="shortcut">
                        <span>Increase Pitch</span>
                        <span class="key">Shift + +</span>
                    </div>
                    <div class="shortcut">
                        <span>Decrease Pitch</span>
                        <span class="key">Shift + -</span>
                    </div>
                </div>

                <div class="shortcut-group">
                    <h4>📋 General</h4>
                    <div class="shortcut">
                        <span>Focus Text Area</span>
                        <span class="key">T</span>
                    </div>
                    <div class="shortcut">
                        <span>Toggle Help</span>
                        <span class="key">H</span>
                    </div>
                    <div class="shortcut">
                        <span>Next Voice</span>
                        <span class="key">↓</span>
                    </div>
                    <div class="shortcut">
                        <span>Previous Voice</span>
                        <span class="key">↑</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">Text Input</div>
                <textarea id="text" class="text-input" placeholder="Enter your text here... Supports markdown formatting that will be automatically processed for natural speech synthesis.">Hello! This is a **professional** text-to-speech application with *natural* voice synthesis.

## Features
- Automatic markdown removal
- Smart speech enhancement
- Multiple language support
- Professional voice quality</textarea>
                
                <div class="processing-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="removeMarkdown" class="checkbox" checked>
                        <label for="removeMarkdown" class="checkbox-label">Auto-remove markdown</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enhanceSSML" class="checkbox" checked>
                        <label for="enhanceSSML" class="checkbox-label">Enhance for speech</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showPreview" class="checkbox" checked>
                        <label for="showPreview" class="checkbox-label">Show processed preview</label>
                    </div>
                </div>

                <div id="previewSection" class="preview-section">
                    <div class="preview-container">
                        <div class="preview-title">
                            <span>🔄</span>
                            <span>Processed Text Preview</span>
                        </div>
                        <div id="previewText" class="preview-text"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Language Selection</div>
                <div class="language-buttons">
                    <button class="lang-btn active" data-lang="en-US" data-key="1">🇺🇸 English <span class="lang-count" id="count-en-US"></span></button>
                    <button class="lang-btn" data-lang="ja-JP" data-key="2">🇯🇵 Japanese <span class="lang-count" id="count-ja-JP"></span></button>
                    <button class="lang-btn" data-lang="vi-VN" data-key="3">🇻🇳 Vietnamese <span class="lang-count" id="count-vi-VN"></span></button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Voice Selection</div>
                <div class="voice-selector">
                    <select id="voiceSelect" class="voice-select">
                        <option>Loading available voices...</option>
                    </select>
                    <div id="voiceInfo" class="voice-info" style="display: none;">
                        <div class="voice-info-content">
                            <span id="voiceQuality" class="voice-quality"></span>
                            <span id="voiceDetails" class="voice-details"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Voice Controls</div>
                <div class="controls-grid">
                    <div class="control-group">
                        <div class="control-label">
                            <span>Speech Rate</span>
                            <span class="control-value" id="rateValue">1.0x</span>
                        </div>
                        <input type="range" id="rateSlider" class="slider" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Pitch Level</span>
                            <span class="control-value" id="pitchValue">1.0</span>
                        </div>
                        <input type="range" id="pitchSlider" class="slider" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="action-buttons">
                    <button id="speakBtn" class="btn btn-primary" data-key="Space">
                        <span>🎤</span> Speak Text
                    </button>
                    <button id="pauseBtn" class="btn btn-warning" data-key="P">
                        <span>⏸️</span> Pause
                    </button>
                    <button id="stopBtn" class="btn btn-secondary" data-key="Esc">
                        <span>⏹️</span> Stop
                    </button>
                </div>
                <div id="status" class="status" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const synth = window.speechSynthesis;
        const voiceSelect = document.getElementById('voiceSelect');
        const textArea = document.getElementById('text');
        const previewText = document.getElementById('previewText');
        const previewSection = document.getElementById('previewSection');
        const removeMarkdownCheckbox = document.getElementById('removeMarkdown');
        const enhanceSSMLCheckbox = document.getElementById('enhanceSSML');
        const showPreviewCheckbox = document.getElementById('showPreview');
        const langButtons = document.querySelectorAll('.lang-btn');
        const speakBtn = document.getElementById('speakBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const rateSlider = document.getElementById('rateSlider');
        const pitchSlider = document.getElementById('pitchSlider');
        const rateValue = document.getElementById('rateValue');
        const pitchValue = document.getElementById('pitchValue');
        const status = document.getElementById('status');
        const voiceInfo = document.getElementById('voiceInfo');
        const voiceQuality = document.getElementById('voiceQuality');
        const voiceDetails = document.getElementById('voiceDetails');

        let voices = [];
        let currentLang = 'en-US';
        let currentUtterance = null;
        let isPaused = false;

        // Markdown removal function
        function removeMarkdown(text) {
            return text
                // Remove code blocks
                .replace(/```[\s\S]*?```/g, '')
                .replace(/`([^`]*)`/g, '$1')
                // Remove headers
                .replace(/^#{1,6}\s+/gm, '')
                // Remove bold and italic
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/__([^_]+)__/g, '$1')
                .replace(/_([^_]+)_/g, '$1')
                // Remove strikethrough
                .replace(/~~([^~]+)~~/g, '$1')
                // Remove links
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/\[([^\]]+)\]\[[^\]]+\]/g, '$1')
                // Remove images
                .replace(/!\[([^\]]*)\]\([^)]+\)/g, '$1')
                // Remove horizontal rules
                .replace(/^[-*_]{3,}$/gm, '')
                // Remove blockquotes
                .replace(/^>\s+/gm, '')
                // Remove list markers
                .replace(/^[\s]*[-*+]\s+/gm, '')
                .replace(/^[\s]*\d+\.\s+/gm, '')
                // Remove extra whitespace
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        // Smart text enhancement for better speech synthesis
        function enhanceForSpeech(text) {
            return text
                // Add natural pauses by duplicating punctuation (which creates longer pauses)
                .replace(/\./g, '...')
                .replace(/!/g, '!!!')
                .replace(/\?/g, '???')
                // Add pauses after colons and semicolons
                .replace(/:/g, ':...')
                .replace(/;/g, ';...')
                // Add slight pause after commas
                .replace(/,/g, ', ')
                // Improve number pronunciation by adding spaces
                .replace(/(\d)([A-Za-z])/g, '$1 $2')
                .replace(/([A-Za-z])(\d)/g, '$1 $2')
                // Add pauses around parentheses
                .replace(/\(/g, '... (')
                .replace(/\)/g, ') ...')
                // Handle common abbreviations
                .replace(/\bDr\./g, 'Doctor')
                .replace(/\bMr\./g, 'Mister')
                .replace(/\bMrs\./g, 'Misses')
                .replace(/\bMs\./g, 'Miss')
                .replace(/\bProf\./g, 'Professor')
                .replace(/\bvs\./g, 'versus')
                .replace(/\betc\./g, 'etcetera')
                .replace(/\bi\.e\./g, 'that is')
                .replace(/\be\.g\./g, 'for example')
                // Handle URLs and emails more naturally
                .replace(/https?:\/\/[^\s]+/g, 'web link')
                .replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, 'email address')
                // Clean up multiple spaces and normalize
                .replace(/\s+/g, ' ')
                .replace(/\.{4,}/g, '...')
                .trim();
        }

        // Process text based on current settings
        function processText(originalText) {
            let processedText = originalText;
            
            if (removeMarkdownCheckbox.checked) {
                processedText = removeMarkdown(processedText);
            }
            
            if (enhanceSSMLCheckbox.checked) {
                processedText = enhanceForSpeech(processedText);
            }
            
            return processedText;
        }

        // Update preview
        function updatePreview() {
            if (!showPreviewCheckbox.checked) {
                previewSection.style.display = 'none';
                return;
            }
            
            previewSection.style.display = 'block';
            const processed = processText(textArea.value);
            previewText.textContent = processed;
        }

        // Event listeners for text processing options
        textArea.addEventListener('input', updatePreview);
        removeMarkdownCheckbox.addEventListener('change', updatePreview);
        enhanceSSMLCheckbox.addEventListener('change', updatePreview);
        showPreviewCheckbox.addEventListener('change', updatePreview);
        voiceSelect.addEventListener('change', updatePreview);

        // Guidelines toggle
        function toggleGuidelines() {
            const guidelines = document.getElementById('guidelines');
            guidelines.classList.toggle('show');
        }

        // Keyboard event handlers
        document.addEventListener('keydown', (e) => {
            // Prevent keyboard shortcuts when typing in text area
            if (e.target === textArea) {
                return;
            }

            // Prevent default for our custom shortcuts
            const shortcutKeys = [' ', 'p', 'P', 'Escape', '1', '2', '3', '+', '-', '=', 'h', 'H', 't', 'T', 'ArrowUp', 'ArrowDown'];
            if (shortcutKeys.includes(e.key) || (e.shiftKey && (e.key === '+' || e.key === '-'))) {
                e.preventDefault();
            }

            switch (e.key) {
                case ' ': // Space - Speak
                    if (!speakBtn.disabled) {
                        speakText();
                    }
                    break;
                case 'p':
                case 'P': // P - Pause/Resume
                    pauseResumeSpeech();
                    break;
                case 'Escape': // Escape - Stop
                    stopSpeech();
                    break;
                case '1': // Language selection
                    switchLanguage('en-US');
                    break;
                case '2':
                    switchLanguage('ja-JP');
                    break;
                case '3':
                    switchLanguage('vi-VN');
                    break;
                case '+':
                case '=':
                    if (e.shiftKey) {
                        // Shift + Plus - Increase pitch
                        adjustPitch(0.1);
                    } else {
                        // Plus - Increase rate
                        adjustRate(0.1);
                    }
                    break;
                case '-':
                    if (e.shiftKey) {
                        // Shift + Minus - Decrease pitch
                        adjustPitch(-0.1);
                    } else {
                        // Minus - Decrease rate
                        adjustRate(-0.1);
                    }
                    break;
                case 'h':
                case 'H': // H - Toggle help
                    toggleGuidelines();
                    break;
                case 't':
                case 'T': // T - Focus text area
                    textArea.focus();
                    break;
                case 'ArrowUp': // Up arrow - Previous voice
                    changeVoice(-1);
                    break;
                case 'ArrowDown': // Down arrow - Next voice
                    changeVoice(1);
                    break;
            }
        });

        // Helper functions for keyboard controls
        function switchLanguage(lang) {
            const targetBtn = document.querySelector(`[data-lang="${lang}"]`);
            if (targetBtn) {
                langButtons.forEach(b => b.classList.remove('active'));
                targetBtn.classList.add('active');
                currentLang = lang;
                populateVoices();
                updatePreview();
            }
        }

        function adjustRate(delta) {
            const newValue = Math.max(0.5, Math.min(2.0, parseFloat(rateSlider.value) + delta));
            rateSlider.value = newValue;
            rateValue.textContent = newValue + 'x';
        }

        function adjustPitch(delta) {
            const newValue = Math.max(0.5, Math.min(2.0, parseFloat(pitchSlider.value) + delta));
            pitchSlider.value = newValue;
            pitchValue.textContent = newValue;
        }

        function changeVoice(direction) {
            const currentIndex = parseInt(voiceSelect.value);
            const options = Array.from(voiceSelect.options);
            let newIndex = currentIndex + direction;

            if (newIndex < 0) newIndex = options.length - 1;
            if (newIndex >= options.length) newIndex = 0;

            if (options[newIndex] && !options[newIndex].disabled) {
                voiceSelect.value = newIndex;
                updateVoiceInfo();
                updatePreview();
            }
        }

        // Voice selection change handler
        voiceSelect.addEventListener('change', updateVoiceInfo);

        function updateVoiceInfo() {
            const selectedIndex = voiceSelect.value;
            if (selectedIndex && voices[selectedIndex]) {
                const voice = voices[selectedIndex];
                const score = getVoiceQualityScore(voice);
                const qualityLabel = getVoiceQualityLabel(score);

                voiceQuality.textContent = qualityLabel;
                voiceDetails.textContent = `${voice.lang} • ${voice.localService ? 'Local' : 'Cloud-based'}`;
                voiceInfo.style.display = 'block';
            } else {
                voiceInfo.style.display = 'none';
            }
        }

        // Language switching functionality
        langButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active button
                langButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update current language
                currentLang = btn.dataset.lang;

                // Update voice dropdown and preview
                populateVoices();
                updatePreview();
            });
        });

        // Slider value updates
        rateSlider.addEventListener('input', () => {
            rateValue.textContent = rateSlider.value + 'x';
        });

        pitchSlider.addEventListener('input', () => {
            pitchValue.textContent = pitchSlider.value;
        });

        function updateLanguageCounts() {
            const languages = ['en-US', 'ja-JP', 'vi-VN'];
            languages.forEach(lang => {
                const count = voices.filter(voice => voice.lang.includes(lang)).length;
                const countElement = document.getElementById(`count-${lang}`);
                if (countElement) {
                    countElement.textContent = count || '0';
                }
            });
        }

        function getVoiceQualityScore(voice) {
            let score = 0;
            const name = voice.name.toLowerCase();

            // Premium quality indicators (highest priority)
            if (name.includes('neural') || name.includes('wavenet')) score += 100;
            if (name.includes('natural') || name.includes('premium')) score += 90;
            if (name.includes('enhanced') || name.includes('improved')) score += 80;

            // Platform-specific high quality voices
            if (name.includes('aria') || name.includes('guy') || name.includes('zira')) score += 70; // Windows premium
            if (name.includes('alex') || name.includes('victoria') || name.includes('samantha')) score += 70; // macOS premium
            if (name.includes('google') && !voice.localService) score += 60; // Google Cloud voices

            // Microsoft voices get speech enhancement boost
            if (name.includes('microsoft') || name.includes('windows')) score += 40;

            // Voice characteristics
            if (!voice.localService) score += 30; // Cloud-based usually better
            if (voice.default) score += 20; // Default often good quality

            // Avoid obviously low-quality voices
            if (name.includes('robot') || name.includes('whisper') || name.includes('novelty')) score -= 50;
            if (name.includes('microsoft david') || name.includes('microsoft zira')) score -= 20; // Older voices

            return score;
        }

        function getVoiceQualityLabel(score) {
            if (score >= 100) return '🌟 Premium';
            if (score >= 80) return '⭐ High Quality';
            if (score >= 60) return '✨ Good';
            if (score >= 40) return '📢 Standard';
            return '🔊 Basic';
        }

        function populateVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';

            // Update language counts
            updateLanguageCounts();

            // Filter voices for current language
            const languageVoices = voices.filter(voice => voice.lang.includes(currentLang));

            if (languageVoices.length === 0) {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = `No voices available for ${currentLang}`;
                placeholder.disabled = true;
                voiceSelect.appendChild(placeholder);
                return;
            }

            // Score and sort voices by quality
            const scoredVoices = languageVoices.map(voice => ({
                voice,
                score: getVoiceQualityScore(voice),
                index: voices.indexOf(voice)
            })).sort((a, b) => b.score - a.score);

            // Populate dropdown with quality indicators
            scoredVoices.forEach(({ voice, score, index }) => {
                const option = document.createElement('option');
                option.value = index;
                const qualityLabel = getVoiceQualityLabel(score);
                option.textContent = `${qualityLabel} ${voice.name}${voice.default ? ' (Default)' : ''}`;
                voiceSelect.appendChild(option);
            });

            // Auto-select highest quality voice
            if (scoredVoices.length > 0) {
                voiceSelect.value = scoredVoices[0].index;
                updateVoiceInfo(); // Show info for auto-selected voice
                updatePreview(); // Update preview with new voice
            }
        }

        function showStatus(message, type = '') {
            status.textContent = message;
            status.style.display = 'block';
            status.className = `status ${type}`;

            if (type !== 'speaking' && type !== 'paused') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Speech synthesis functions
        function speakText() {
            const originalText = textArea.value.trim();
            if (!originalText) {
                showStatus('⚠️ Please enter some text first.');
                return;
            }

            const selectedIndex = voiceSelect.value;
            if (selectedIndex === '') {
                showStatus('⚠️ No valid voice selected.');
                return;
            }

            // Stop any ongoing speech
            synth.cancel();
            isPaused = false;

            // Process the text
            const processedText = processText(originalText);
            
            currentUtterance = new SpeechSynthesisUtterance(processedText);
            const chosenVoice = voices[selectedIndex];

            if (chosenVoice) {
                currentUtterance.voice = chosenVoice;
            }

            // Apply rate and pitch settings
            currentUtterance.rate = parseFloat(rateSlider.value);
            currentUtterance.pitch = parseFloat(pitchSlider.value);

            // Event handlers
            currentUtterance.onstart = () => {
                showStatus('🎤 Speaking...', 'speaking');
                speakBtn.disabled = true;
                pauseBtn.disabled = false;
                pauseBtn.innerHTML = '<span>⏸️</span> Pause';
            };

            currentUtterance.onend = () => {
                showStatus('✅ Speech completed.');
                speakBtn.disabled = false;
                pauseBtn.disabled = true;
                isPaused = false;
            };

            currentUtterance.onerror = (event) => {
                showStatus(`❌ Error: ${event.error}`);
                speakBtn.disabled = false;
                pauseBtn.disabled = true;
                isPaused = false;
            };

            synth.speak(currentUtterance);
        }

        function pauseResumeSpeech() {
            if (synth.speaking) {
                if (isPaused) {
                    synth.resume();
                    showStatus('▶️ Speech resumed.', 'speaking');
                    pauseBtn.innerHTML = '<span>⏸️</span> Pause';
                    isPaused = false;
                } else {
                    synth.pause();
                    showStatus('⏸️ Speech paused.', 'paused');
                    pauseBtn.innerHTML = '<span>▶️</span> Resume';
                    isPaused = true;
                }
            }
        }

        function stopSpeech() {
            synth.cancel();
            showStatus('⏹️ Speech stopped.');
            speakBtn.disabled = false;
            pauseBtn.disabled = true;
            pauseBtn.innerHTML = '<span>⏸️</span> Pause';
            isPaused = false;
        }

        // Button event listeners
        speakBtn.addEventListener('click', speakText);
        pauseBtn.addEventListener('click', pauseResumeSpeech);
        stopBtn.addEventListener('click', stopSpeech);

        // Initialize voices
        populateVoices();

        // Handle voice loading
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                populateVoices();
                updatePreview();
            };
        }

        // Handle browser support
        if (!('speechSynthesis' in window)) {
            showStatus('❌ Speech synthesis not supported in this browser.');
            speakBtn.disabled = true;
            pauseBtn.disabled = true;
        } else {
            // Initial setup
            pauseBtn.disabled = true;
            setTimeout(() => {
                updateLanguageCounts();
                updatePreview();
            }, 100);
        }
    </script>
</body>
</html>
